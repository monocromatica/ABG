/**
 * jquery.stapel.js v1.0.0
 * http://www.codrops.com
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * Copyright 2012, Codrops
 * http://www.codrops.com
 */(function(e,t,n){"use strict";var r=e.event,i,s;i=r.special.debouncedresize={setup:function(){e(this).on("resize",i.handler)},teardown:function(){e(this).off("resize",i.handler)},handler:function(e,t){var n=this,o=arguments,u=function(){e.type="debouncedresize";r.dispatch.apply(n,o)};s&&clearTimeout(s);t?u():s=setTimeout(u,i.threshold)},threshold:150};var o="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";e.fn.imagesLoaded=function(t){function c(){var n=e(f),s=e(l);i&&(l.length?i.reject(u,n,s):i.resolve(u));e.isFunction(t)&&t.call(r,u,n,s)}function h(t,n){if(t.src===o||e.inArray(t,a)!==-1)return;a.push(t);n?l.push(t):f.push(t);e.data(t,"imagesLoaded",{isBroken:n,src:t.src});s&&i.notifyWith(e(t),[n,u,e(f),e(l)]);if(u.length===a.length){setTimeout(c);u.unbind(".imagesLoaded")}}var r=this,i=e.isFunction(e.Deferred)?e.Deferred():0,s=e.isFunction(i.notify),u=r.find("img").add(r.filter("img")),a=[],f=[],l=[];e.isPlainObject(t)&&e.each(t,function(e,n){e==="callback"?t=n:i&&i[e](n)});u.length?u.bind("load.imagesLoaded error.imagesLoaded",function(e){h(e.target,e.type==="error")}).each(function(t,r){var i=r.src,s=e.data(r,"imagesLoaded");if(s&&s.src===i){h(r,s.isBroken);return}if(r.complete&&r.naturalWidth!==n){h(r,r.naturalWidth===0||r.naturalHeight===0);return}if(r.readyState||r.complete){r.src=o;r.src=i}}):c();return i?i.promise(r):r};var u=e(t),a=t.Modernizr;e.Stapel=function(t,n){this.el=e(n);this._init(t)};e.Stapel.defaults={gutter:40,pileAngles:2,pileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:400,closeEasing:"ease-in-out"},otherPileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:350,closeEasing:"ease-in-out"},delay:0,randomAngle:!1,onLoad:function(){return!1},onBeforeOpen:function(e){return!1},onAfterOpen:function(e,t){return!1},onBeforeClose:function(e){return!1},onAfterClose:function(e,t){return!1}};e.Stapel.prototype={_init:function(t){this.options=e.extend(!0,{},e.Stapel.defaults,t);this._config();var n=this;this.el.imagesLoaded(function(){n.options.onLoad();n._layout();n._initEvents()})},_config:function(){this.support=a.csstransitions;var t={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"},n={WebkitTransform:"-webkit-transform",MozTransform:"-moz-transform",OTransform:"-o-transform",msTransform:"-ms-transform",transform:"transform"};if(this.support){this.transEndEventName=t[a.prefixed("transition")]+".cbpFWSlider";this.transformName=n[a.prefixed("transform")]}this.spread=!1;this.items=this.el.children("li").hide();this.close=e("#tp-close")},_getSize:function(){this.elWidth=this.el.outerWidth(!0)},_initEvents:function(){var t=this;u.on("debouncedresize.stapel",function(){t._resize()});this.items.on("click.stapel",function(){var n=e(this);if(!t.spread&&n.data("isPile")){t.spread=!0;t.pileName=n.data("pileName");t.options.onBeforeOpen(t.pileName);t._openPile();return!1}})},_layout:function(){this._piles();this.itemSize={width:this.items.outerWidth(!0),height:this.items.outerHeight(!0)};this.items.remove();this._setInitialStyle();this.el.css("min-width",this.itemSize.width+this.options.gutter);this._getSize();this._setItemsPosition();this.items=this.el.children("li").show();this.itemsCount=this.items.length},_piles:function(){this.piles={};var t,n=this,r=0;this.items.each(function(){var i=e(this),s=i.attr("data-pile")||"nopile-"+i.index(),o=s.split(",");for(var u=0,a=o.length;u<a;++u){var f=e.trim(o[u]);t=n.piles[f];if(!t){t=n.piles[f]={elements:[],position:{left:0,top:0},index:r};++r}var l=i.clone().get(0);t.elements.push({el:l,finalPosition:{left:0,top:0}});e(l).appendTo(n.el)}})},_setInitialStyle:function(){for(var t in this.piles){var n=this.piles[t];for(var r=0,i=n.elements.length;r<i;++r){var s=e(n.elements[r].el),o={transform:"rotate(0deg)"};this._applyInitialTransition(s);if(r===i-2)o={transform:"rotate("+this.options.pileAngles+"deg)"};else if(r===i-3)o={transform:"rotate(-"+this.options.pileAngles+"deg)"};else if(r!==i-1){var u={visibility:"hidden"};s.css(u).data("extraStyle",u)}else t.substr(0,6)!=="nopile"&&s.data("front",!0).append('<div class="tp-title"><span>'+t+"</span><span>"+i+"</span></div>");s.css(o).data({initialStyle:o,pileName:t,pileCount:i,shadow:s.css("box-shadow"),isPile:t.substr(0,6)==="nopile"?!1:!0})}}},_applyInitialTransition:function(e){this.support&&e.css("transition","left 400ms ease-in-out, top 400ms ease-in-out")},_setItemsPosition:function(){var t=0,n=0,r,i,s=0,o=0;for(var u in this.piles){var a=this.piles[u],f=this.itemSize.width+this.options.gutter,l=0,c=0,h,p;if(t+f<=this.elWidth){r=t;i=n;t+=f}else{s===0&&(s=Math.ceil((this.elWidth-t+this.options.gutter)/2));n+=this.itemSize.height+this.options.gutter;r=0;i=n;t=f}a.position.left=r;a.position.top=i;for(var d=0,v=a.elements.length;d<v;++d){var m=a.elements[d],g=m.finalPosition;if(l+f<=this.elWidth){h=l;p=c;l+=f}else{c+=this.itemSize.height+this.options.gutter;h=0;p=c;l=f}g.left=h;g.top=p;var y=e(m.el);if(u!==this.pileName)y.css({left:a.position.left,top:a.position.top});else{o=m.finalPosition.top;y.css({left:m.finalPosition.left,top:o})}}}o=this.spread?o:n;this.el.css({marginLeft:s,height:o+this.itemSize.height})},_openPile:function(){if(!this.spread)return!1;var t;for(var n in this.piles){var r=this.piles[n],i=0;for(var s=0,o=r.elements.length;s<o;++s){var u=r.elements[s],a=e(u.el),f=a.find("img"),l=n===this.pileName?{zIndex:9999,visibility:"visible",transition:this.support?"left "+this.options.pileAnimation.openSpeed+"ms "+(o-s-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing+", top "+this.options.pileAnimation.openSpeed+"ms "+(o-s-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing+", "+this.transformName+" "+this.options.pileAnimation.openSpeed+"ms "+(o-s-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing:"none"}:{zIndex:1,transition:this.support?"opacity "+this.options.otherPileAnimation.closeSpeed+"ms "+this.options.otherPileAnimation.closeEasing:"none"};if(n===this.pileName){a.data("front")&&a.find("div.tp-title").hide();s<o-1&&f.css("visibility","visible");t=u.finalPosition;t.transform=this.options.randomAngle&&s!==r.index?"rotate("+Math.floor(Math.random()*11-5)+"deg)":"none";this.support||a.css("transform","none");s<o-3&&a.css("box-shadow","none")}else s<o-1&&f.css("visibility","hidden");a.css(l);var c=this;n===this.pileName?this._applyTransition(a,t,this.options.pileAnimation.openSpeed,function(t){var n=this.target||this.nodeName;if(n!=="LI")return;var r=e(this);r.css("box-shadow",r.data("shadow"));c.support&&r.off(c.transEndEventName);++i;if(i===r.data("pileCount")){e(document).one("mousemove.stapel",function(){c.el.addClass("tp-open")});c.options.onAfterOpen(c.pileName,i)}}):this._applyTransition(a,{opacity:0},this.options.otherPileAnimation.closeSpeed)}}this.el.css("height",t.top+this.itemSize.height)},_closePile:function(){var t=this;if(this.spread){this.spread=!1;this.options.onBeforeClose(this.pileName);this.el.removeClass("tp-open");var n;for(var r in this.piles){var i=this.piles[r],s=0;for(var o=0,u=i.elements.length;o<u;++o){var a=e(i.elements[o].el),f=r===this.pileName?{transition:this.support?"left "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", top "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", "+this.transformName+" "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing:"none"}:{transition:this.support?"opacity "+this.options.otherPileAnimation.openSpeed+"ms "+this.options.otherPileAnimation.openEasing:"none"};a.css(f);n=i.position;if(r===this.pileName){e.extend(n,a.data("initialStyle"));o<u-3&&a.css("box-shadow","none")}r===this.pileName?this._applyTransition(a,n,this.options.pileAnimation.closeSpeed,function(n){var r=this.target||this.nodeName;if(r!=="LI")return;var i=e(this),o=i.data("extraStyle");i.css("box-shadow",i.data("shadow"));if(t.support){i.off(t.transEndEventName);t._applyInitialTransition(i)}else i.css(i.data("initialStyle"));o&&i.css(o);++s;i.data("front")&&i.find("div.tp-title").show();s===i.data("pileCount")&&t.options.onAfterClose(i.data("pileName"),s)}):this._applyTransition(a,{opacity:1},this.options.otherPileAnimation.openSpeed,function(n){var r=this.target||this.nodeName;if(r!=="LI")return;var i=e(this);i.index()<u-1&&i.find("img").css("visibility","visible");if(t.support){i.off(t.transEndEventName);t._applyInitialTransition(i)}})}}this.pileName="";this.el.css("height",n.top+this.itemSize.height)}return!1},_resize:function(){this._getSize();this._setItemsPosition()},_applyTransition:function(t,n,r,i){e.fn.applyStyle=this.support?e.fn.css:e.fn.animate;i&&this.support&&t.on(this.transEndEventName,i);i=i||function(){return!1};t.stop().applyStyle(n,e.extend(!0,[],{duration:r+"ms",complete:i}))},closePile:function(){this._closePile()}};var f=function(e){t.console&&t.console.error(e)};e.fn.stapel=function(t){var n=e.data(this,"stapel");if(typeof t=="string"){var r=Array.prototype.slice.call(arguments,1);this.each(function(){if(!n){f("cannot call methods on stapel prior to initialization; attempted to call method '"+t+"'");return}if(!e.isFunction(n[t])||t.charAt(0)==="_"){f("no such method '"+t+"' for stapel instance");return}n[t].apply(n,r)})}else this.each(function(){n?n._init():n=e.data(this,"stapel",new e.Stapel(t,this))});return n}})(jQuery,window);